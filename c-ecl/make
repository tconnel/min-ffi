#!/bin/bash -e
fullpath=$(realpath $(dirname $0))
cd $fullpath
[[ -x clean ]] && ./clean
mkdir -p bin obj lib
#ecl -h identity.h -c identity.c -data lib/libidentity.data -o lib/libidentity.so -compile identity.lisp >/dev/null
#ecl -s -h identity.h -o lib/libidentity.so -compile identity.lisp
#gcc -g -fPIC -c main.c -o obj/main.o
#gcc -fPIC -c identity.c -o obj/identity.o
#gcc -Wl,-rpath=${fullpath}/lib obj/main.o -Llib -lidentity -L/usr/local/lib -lecl -o bin/identity #-Wl,--no-undefined 

#ecl -s -q -h identity.h -o lib/libidentity.so --compile identity.lisp
#gcc -o bin/identity main.c -Llib -lidentity -L/usr/local/lib -lecl

ecl -load compile.lisp
gcc -Wl,--no-undefined -Wl,-rpath=. -o bin/identity main.c -L. -lidentity -lecl

[[ -x bin/identity ]] && ./bin/identity || exit 1
